{"version":3,"sources":["assets\\scripts\\showcase\\dialog\\DlgSign.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,gEAA2D;AAC3D,sDAAiD;AACjD,0DAAyD;AACzD,8CAAgD;AAChD,0DAAyE;AACzE,mDAA8C;AAExC,IAAA,KAA8B,EAAE,CAAC,UAAU,EAAzC,OAAO,aAAA,EAAE,QAAQ,cAAA,EAAE,IAAI,UAAkB,CAAC;AAGlD;IAAqC,2BAAU;IAA/C;QAAA,qEAgGC;QA7FsB,WAAK,GAAY,IAAI,CAAA;QAChC,gBAAU,GAAW,CAAC,CAAA,CAAC,QAAQ;;IA4F3C,CAAC;IA1Fa,wBAAM,GAAhB;QACI,iBAAM,MAAM,WAAE,CAAC;QACf,gBAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;IAC1B,CAAC;IAES,2BAAS,GAAnB;QACI,gBAAM,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;IAC3B,CAAC;IAES,wBAAM,GAAhB,cAAqB,CAAC;IAEtB;;OAEG;IACI,wBAAM,GAAb;QAAA,iBASC;QARG,eAAe;QACf,IAAI,CAAC,UAAU,GAAG,kBAAQ,CAAC,QAAQ,CAAC,UAAU,IAAI,CAAC,CAAA;QACnD,WAAW;QACX,IAAI,CAAC,mBAAmB,EAAE,CAAA;QAE1B,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAC,IAAI,EAAE,KAAK;YACpC,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,MAAM,GAAG,KAAK,GAAG,KAAI,CAAC,UAAU,CAAA;QAChE,CAAC,CAAC,CAAA;IACN,CAAC;IAED,kCAAgB,GAAhB;QACI,YAAY;QACZ,IAAI,IAAI,CAAC,eAAe,EAAE,EAAE;YACxB,eAAK,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,EAAE,GAAG,CAAC,EAAE,CAAC,CAAA;YACvE,OAAM;SACT;QACD,eAAK,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,EAAE,GAAG,CAAC,EAAE,CAAC,CAAA;QAEzE,SAAS;QACT,IAAI,CAAC,MAAM,EAAE,CAAA;QAEb,WAAW;QACX,IAAI,CAAC,mBAAmB,EAAE,CAAA;IAC9B,CAAC;IAGO,wBAAM,GAAd;QAAA,iBAmBC;QAlBG,kBAAQ,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,GAAG,GAAG,CAAA;QAErD,UAAU;QACV,IAAI,CAAC,UAAU,EAAE,CAAA;QACjB,IAAM,QAAQ,GAAG,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC,KAAK,CAAC,CAAC,EAAE,EAAE,CAAC,CAAA;QAEtD,eAAe;QACf,yEAAyE;QACzE,kBAAQ,CAAC,QAAQ,CAAC,UAAU,GAAG,IAAI,CAAC,UAAU,CAAA;QAC9C,kBAAQ,CAAC,QAAQ,CAAC,cAAc,GAAG,QAAQ,CAAA;QAE3C,yBAAc,CAAC,WAAW,EAAE,CAAA;QAC5B,gBAAM,CAAC,IAAI,CAAC,qBAAS,CAAC,WAAW,CAAC,CAAA;QAElC,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAC,IAAI,EAAE,KAAK;YACpC,IAAM,GAAG,GAAG,KAAK,GAAG,KAAI,CAAC,UAAU,CAAA;YACnC,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,MAAM,GAAG,GAAG,CAAA;QAC5C,CAAC,CAAC,CAAA;IACN,CAAC;IAEO,iCAAe,GAAvB;QACI,4BAA4B;QAC5B,IAAM,QAAQ,GAAG,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC,KAAK,CAAC,CAAC,EAAE,EAAE,CAAC,CAAA;QACtD,eAAe;QACf,IAAM,iBAAiB,GAAG,kBAAQ,CAAC,QAAQ,CAAC,cAAc,CAAA;QAC1D,0BAA0B;QAC1B,OAAO,iBAAiB,KAAK,QAAQ,CAAA;IACzC,CAAC;IAEO,qCAAmB,GAA3B;QACI,sDAAsD;QACtD,YAAY;QACZ,gCAAgC;QAChC,gFAAgF;QAChF,WAAW;QACX,+EAA+E;QAC/E,IAAI;IACR,CAAC;IAED,sCAAoB,GAApB;QACI,UAAU;QACV,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;QACpB,SAAS;QACT,EAAE,CAAC,GAAG,CAAC,YAAY,CAAC,UAAU,CAAC,YAAY,CAAC,CAAC;QAC7C,EAAE,CAAC,GAAG,CAAC,YAAY,CAAC,UAAU,CAAC,gBAAgB,CAAC,CAAC;QACjD,WAAW;QACX,IAAI,CAAC,mBAAmB,EAAE,CAAC;IAC/B,CAAC;IA9Fa,YAAI,GAAW,YAAM,CAAC,aAAa,GAAG,SAAS,CAAC;IAE3C;QAAlB,QAAQ,CAAC,EAAE,CAAC,IAAI,CAAC;0CAAsB;IAHvB,OAAO;QAD3B,OAAO;OACa,OAAO,CAgG3B;IAAD,cAAC;CAhGD,AAgGC,CAhGoC,oBAAU,GAgG9C;kBAhGoB,OAAO","file":"","sourceRoot":"/","sourcesContent":["import DialogBase from \"../../common/cmpt/base/DialogBase\";\r\nimport Layer from \"../../common/cmpt/base/Layer\";\r\nimport { EventName } from \"../../common/const/EventName\";\r\nimport { DirUrl } from \"../../common/const/Url\";\r\nimport UserInfo, { UserInfoStorge } from \"../../common/runtime/UserInfo\";\r\nimport Events from \"../../common/util/Events\";\r\n\r\nconst { ccclass, property, menu } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class DlgSign extends DialogBase {\r\n    public static pUrl: string = DirUrl.PREFAB_DIALOG + \"DlgSign\";\r\n\r\n    @property(cc.Node) signs: cc.Node = null\r\n    private signInDays: number = 0 // 已签到天数\r\n\r\n    protected onLoad() {\r\n        super.onLoad();\r\n        Events.targetOn(this);\r\n    }\r\n\r\n    protected onDestroy() {\r\n        Events.targetOff(this);\r\n    }\r\n\r\n    protected update() { }\r\n\r\n    /**\r\n     * @override\r\n     */\r\n    public onOpen() {\r\n        // 从本地存储获取已签到天数\r\n        this.signInDays = UserInfo.instance.signInDays || 0\r\n        // 更新签到按钮文本\r\n        this.updateSignInBtnText()\r\n\r\n        this.signs.children.forEach((item, index) => {\r\n            item.getChildByName('down').active = index < this.signInDays\r\n        })\r\n    }\r\n\r\n    onSignInBtnClick() {\r\n        // 判断今天是否已签到\r\n        if (this.isTodaySignedIn()) {\r\n            Layer.inst.showTip({ text: \"今日已签到\", unique: true, end: cc.v2(0, 100) })\r\n            return\r\n        }\r\n        Layer.inst.showTip({ text: \"签到奖励已领取\", unique: true, end: cc.v2(0, 100) })\r\n\r\n        // 执行签到操作\r\n        this.signIn()\r\n\r\n        // 更新签到按钮文本\r\n        this.updateSignInBtnText()\r\n    }\r\n\r\n\r\n    private signIn() {\r\n        UserInfo.instance.coin += (this.signInDays + 1) * 100\r\n\r\n        // 更新已签到天数\r\n        this.signInDays++\r\n        const todayStr = new Date().toISOString().slice(0, 10)\r\n\r\n        // 存储已签到天数到本地存储\r\n        // cc.sys.localStorage.setItem(\"signInDays\", this.signInDays.toString());\r\n        UserInfo.instance.signInDays = this.signInDays\r\n        UserInfo.instance.lastSignInDate = todayStr\r\n\r\n        UserInfoStorge.setUserInfo()\r\n        Events.emit(EventName.UPDATE_COIN)\r\n\r\n        this.signs.children.forEach((item, index) => {\r\n            const res = index < this.signInDays\r\n            item.getChildByName('down').active = res\r\n        })\r\n    }\r\n\r\n    private isTodaySignedIn(): boolean {\r\n        // 获取今天的日期字符串，格式为 yyyy-mm-dd\r\n        const todayStr = new Date().toISOString().slice(0, 10)\r\n        // 获取上一次签到日期字符串\r\n        const lastSignInDateStr = UserInfo.instance.lastSignInDate\r\n        // 判断上一次签到日期字符串是否是今天的日期字符串\r\n        return lastSignInDateStr === todayStr\r\n    }\r\n\r\n    private updateSignInBtnText() {\r\n        // this.signInText.string = `已连续签到${this.signInDays}天`\r\n        // 判断今天是否已签到\r\n        // if (this.isTodaySignedIn()) {\r\n        //     this.signInBtn.getComponent(cc.Button).interactable = false // 今天已签到，禁用按钮\r\n        // } else {\r\n        //     this.signInBtn.getComponent(cc.Button).interactable = true // 今天未签到，启用按钮\r\n        // }\r\n    }\r\n\r\n    onStopSignInBtnClick() {\r\n        // 重置已签到天数\r\n        this.signInDays = 0;\r\n        // 清除本地存储\r\n        cc.sys.localStorage.removeItem(\"signInDays\");\r\n        cc.sys.localStorage.removeItem(\"lastSignInDate\");\r\n        // 更新签到按钮文本\r\n        this.updateSignInBtnText();\r\n    }\r\n}\r\n"]}